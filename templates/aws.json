{
  "variables": {
    "comment": "trusty 14.04.3 20150810 us-east-1 ssd",
    "base_ami": "ami-7ff05814",
    "region": "us-east-1",
    "version": "0"
  },
  "builders": [{
    "type": "amazon-ebs",
    "ami_name": "concourse-{{user `version`}}",
    "ami_groups": ["all"],
    "instance_type": "m1.large",
    "region": "{{user `region`}}",
    "source_ami":  "{{user `base_ami`}}",
    "ssh_username": "ubuntu",
    "ami_description": "Concourse AMI (version {{user `version`}})"
  }],
  "provisioners": [{
    "type": "shell",
    "inline": "while [ ! -f /var/lib/cloud/instance/boot-finished ] ; do sleep 1; done"
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "scripts": [
      "scripts/quiet-tty-warning.sh",
      "scripts/update-sources-list.sh",
      "scripts/update-trusty-kernel.sh",
      "scripts/kernel-cleanup.sh",
      "scripts/admin-sudoers.sh",
      "scripts/setup-syslog.sh"
    ]
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "scripts": [
      "scripts/aws-grub.sh",
      "scripts/aws-preseed.sh",
      "scripts/vagrant-pub-key.sh"
    ]
  },{
    "type": "file",
    "source": "concourse.tgz",
    "destination": "/tmp/concourse.tgz"
  },{
    "type": "file",
    "source": "garden-linux.tgz",
    "destination": "/tmp/garden-linux.tgz"
  },{
    "type": "packer-bosh",
    "assets_dir": "/opt/local/go/src/github.com/cppforlife/packer-bosh/bosh-provisioner/assets",
    "manifest_path": "concourse_manifest.yml",
    "ssh_password": "vagrant"
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "remote_path": "/opt/bosh-provisioner/packer-shell.sh",
    "scripts": [
      "scripts/set-temp-dir.sh",
      "scripts/clean-up.sh",
      "scripts/shrink-disk.sh"
    ]
  }],

  "post-processors": [{
    "type": "vagrant",
    "keep_input_artifact": true,
    "vagrantfile_template": "templates/vagrant-aws.tpl",
    "output": "concourse-{{ .Provider }}-ubuntu-trusty-{{user `version`}}.box"
  }]
}
