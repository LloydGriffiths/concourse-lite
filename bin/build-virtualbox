#!/bin/bash

set -e -x

CONCOURSE_RELEASE_VERSION=${1}
GARDEN_LINUX_RELEASE_VERSION=${2}

function usage() {
  echo "usage: $0 CONCOURSE_RELEASE_VERSION GARDEN_LINUX_RELEASE_VERSION" >&2
  exit 1
}

[ -n "$CONCOURSE_RELEASE_VERSION" ] || usage
[ -n "$GARDEN_LINUX_RELEASE_VERSION" ] || usage

bin_dir=$(dirname $0)
build_dir=$(cd $(dirname $0)/.. && pwd)
templates_dir=$(cd ${build_dir}/templates && pwd)

${bin_dir}/generate-concourse-manifest ${CONCOURSE_RELEASE_VERSION} ${GARDEN_LINUX_RELEASE_VERSION}

# fetch assets; disregard provisioner binary
${bin_dir}/fetch-packer-bosh

rm -rf $(dirname $0)/../output-virtualbox-iso

packer build -var "version=${CONCOURSE_RELEASE_VERSION}" \
  ${templates_dir}/virtualbox.json
