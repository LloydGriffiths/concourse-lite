#!/bin/bash

set -e -x

PROVIDER=${1}
shift

function install_virtualbox() {
  if which VBoxManage >/dev/null 2>&1 && \
      VBoxManage --version | grep 4.3.18 >/dev/null 2>&1; then
    return
  fi

  pushd /tmp
    wget http://download.virtualbox.org/virtualbox/4.3.18/virtualbox-4.3_4.3.18-96516~Ubuntu~raring_amd64.deb -O virtualbox.deb
    sudo dpkg -i virtualbox.deb
    rm virtualbox.deb
  popd
}

function install_packer() {
  if [ -f "$1/packer" ] && [ "$($1/packer -v)" == "Packer v0.7.2" ]; then
    return
  fi

  sudo apt-get -y install unzip

  pushd $1
    wget https://dl.bintray.com/mitchellh/packer/packer_0.7.2_linux_amd64.zip -O packer.zip
    unzip -o packer.zip
    rm packer.zip
  popd
}

lite_dir=$(cd $(dirname $0)/.. && pwd)

packer_bin_dir=${lite_dir}/packer_bin
mkdir -p ${packer_bin_dir}
export PATH=${packer_bin_dir}:$PATH

export GOPATH=${lite_dir}/gopath
mkdir -p $GOPATH
export PATH=${GOPATH}/bin:$PATH

sudo apt-get -y install golang git

install_virtualbox
install_packer ${packer_bin_dir}

cd ${lite_dir}

# clear out old boxes so only one gets scp'd back
rm -f *.box

export PACKER_CONFIG=$(./bin/fetch-packer-bosh)

./bin/build-${PROVIDER} "$@"
