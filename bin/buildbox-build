#!/bin/bash

set -e -x

PROVIDER=${1}
shift

function install_packer() {
  if [ -f "$1/packer" ]; then
    return
  fi

  pushd $1
    wget https://dl.bintray.com/mitchellh/packer/0.6.1_linux_amd64.zip -O packer.zip
    unzip packer.zip
    rm packer.zip
  popd
}

function install_packer_bosh() {
  go get -d github.com/cppforlife/packer-bosh >&2
  go get github.com/tools/godep >&2

  pushd ${GOPATH}/src/github.com/cppforlife/packer-bosh >&2
    git submodule update --init --recursive >&2
    godep go build -o out/packer-bosh ./main
    echo -n $(pwd)/out/packer-bosh
  popd >&2
}

lite_dir=$(cd $(dirname $0)/.. && pwd)

packer_bin_dir=${lite_dir}/packer_bin
mkdir -p ${packer_bin_dir}
export PATH=${packer_bin_dir}:$PATH

export GOPATH=${lite_dir}/gopath
mkdir -p $GOPATH
export PATH=${GOPATH}/bin:$PATH

sudo apt-get -y install virtualbox virtualbox-guest-additions-iso golang git

install_packer ${packer_bin_dir}

packer_bosh_provisioner=$(install_packer_bosh)
cat > ${lite_dir}/.packerconfig <<EOF
{
  "provisioners": {
    "packer-bosh": "${packer_bosh_provisioner}"
  }
}
EOF

export PACKER_CONFIG=${lite_dir}/.packerconfig

cd ${lite_dir}
./bin/build-${PROVIDER} "$@"
